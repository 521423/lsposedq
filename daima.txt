import requests
from bs4 import BeautifulSoup
from datetime import datetime

class SuperstudyTaskManager:
    def __init__(self, username, password):
        self.session = requests.Session()
        self.login_url = "https://passport2.chaoxing.com/login"
        self.tasks_url = "https://mooc1-1.chaoxing.com/calendar/getEventList"
        self.headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
        }
        self.login(username, password)

    def login(self, username, password):
        # è¿™é‡Œéœ€è¦å¤„ç†åŠ å¯†å‚æ•°ï¼Œå®é™…ç™»å½•æµç¨‹æ›´å¤æ‚
        login_data = {
            "uname": username,
            "password": password,
            "refer": "http://i.mooc.chaoxing.com"
        }
        response = self.session.post(self.login_url, data=login_data, headers=self.headers)
        if "ç™»å½•æˆåŠŸ" not in response.text:
            raise Exception("ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ")

    def get_tasks(self):
        response = self.session.get(self.tasks_url, headers=self.headers)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        tasks = []
        for item in soup.select('.event-list li'):
            try:
                title = item.select_one('.title').text.strip()
                course = item.select_one('.course').text.strip()
                time_str = item.select_one('.time').text.strip()
                status = item.select_one('.status').text.strip()
                
                # è½¬æ¢æ—¶é—´æ ¼å¼
                end_time = datetime.strptime(time_str, "%Y-%m-%d %H:%M")
                remaining = (end_time - datetime.now()).days
                
                tasks.append({
                    "è¯¾ç¨‹": course,
                    "ä»»åŠ¡åç§°": title,
                    "æˆªæ­¢æ—¶é—´": end_time.strftime("%Y-%m-%d %H:%M"),
                    "å‰©ä½™å¤©æ•°": remaining,
                    "çŠ¶æ€": status
                })
            except Exception as e:
                continue
        return tasks

    def show_tasks(self):
        tasks = self.get_tasks()
        print("\nğŸ“š å­¦ä¹ é€šä»»åŠ¡ä¸€è§ˆ")
        print("="*60)
        for idx, task in enumerate(tasks, 1):
            status_icon = "âœ…" if "å·²å®Œæˆ" in task["çŠ¶æ€"] else "âš ï¸"
            print(f"{idx}. [{status_icon}] {task['è¯¾ç¨‹']}")
            print(f"  ä»»åŠ¡ï¼š{task['ä»»åŠ¡åç§°']}")
            print(f"  æˆªæ­¢ï¼š{task['æˆªæ­¢æ—¶é—´']}ï¼ˆå‰©ä½™{task['å‰©ä½™å¤©æ•°']}å¤©ï¼‰")
            print("-"*60)

if __name__ == "__main__":
    # ä½¿ç”¨ç¤ºä¾‹ï¼ˆéœ€è¦è¾“å…¥çœŸå®è´¦å·å¯†ç ï¼‰
    try:
        username = input("è¯·è¾“å…¥å­¦ä¹ é€šè´¦å·ï¼š")
        password = input("è¯·è¾“å…¥å¯†ç ï¼š")
        manager = SuperstudyTaskManager(username, password)
        manager.show_tasks()
    except Exception as e:
        print(f"å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")